---
title: Tone and Topic on Twitter in U.S. Politics
author: "Davey Proctor"
date: "April 26, 2019"
number_sections: yes
output:
  pdf_document: default
  html_document:
    df_print: paged
bibliography: references.bib
urlcolor: blue
---

# Abstract

I explore the use of social media by politicians. What types of Tweeting behavior relates to a politician's electability? I find Democrats rally more around key hashtags that improve their social media visibility and correlate with election day success. I also find that, leading up to an election, the dominant tone that a politician expresses - fear, joy, disgust, etc. - is related to the fraction of votes they'll receive. This effect interacts with gender: women, more than men, are favored for pessimistic tones. One possible explanation is that women receive more retweets for these tones leading up to the election, getting their views out there more efficiently.

\centering

\raggedright

\clearpage

\tableofcontents


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = F, results='hide', message=F, warning=F, cache=T, tidy.opts=list(width.cutoff=80),tidy=T)
```

```{r}
# Dependencies
# The usual
library(dplyr)
library(ggplot2)
th <- theme(plot.title = element_text(hjust = 0.5))
ax <- theme(axis.text.x = element_text(angle = 45, hjust = 1))
library(grid)
library(gridExtra)
library(lubridate)
library(reshape2)
library(stringi)
library(tidyr)
# Word cloud
library(tm)
library(scales)
library(SnowballC)
library(wordcloud)
library(RColorBrewer)
library(wordcloud2)
library(webshot)
library(htmlwidgets)
# Topic models
library(topicmodels)
library(tidytext)
library(tidyr)
library(tm)
library(textstem)
library(readr)
library(stringr)
# Structured topic models
# library(stm)
# Formatting for Rmd
library(pander)
panderOptions('digits',2)
```

# Introduction

We've seen a huge increase in the use of social media; on Twitter an estimated 500 million tweets are sent every day. Politicians use Twitter to mobilize support, attack opponents, share news that endorses their policy, and more. They can make their views more visible to the public when followers choose to retweet - copy the message - for their own followers to see.

A number of strategies on Twitter have been identified. @Stieglitz present a "methodological framework for social media analytics in political context," which includes content analysis, opinion mining, and social network analysis to ask questions such as who are the political opinion leaders and what are the emerging political topics. @Hellweg found that social media use, particularly if personal rather than professional in tone, can significanly enhance the perception followers have of a candidate. Going further with a tweet's tone, @Proctor looked to identify differences in the amount of confidence, tentativeness, analyticalness, etc., that appear in male and female tweets. The study found no measurable difference by gender, but suggested users might selectively retweet based on the tone of the message.

Going further with retweets as a measure of visibility, @Nilizadeh2016TwittersGC found a glass ceiling for visibility on Twitter: women at the highest levels of visibility fail to track against the most visible men in achieving retweets. 

I ask how several of these identified strategies achieve different payoffs come election day. First I'll analyze the use of Twitter at the coarse level of tweet frequency - who's been adopting the medium over time, and why? Second, I find certain interprettable, polarized topics which help explain the draw to social media for different politicians. Furthermore, I identify certain topics that, when tweeted about, have historically led to election success. Finally, I follow @Proctor in analysis of tone, aligning the use of certain tones to election success.

# Dataset Overview

## Individuals

```{r}
metaDF <- read.csv("US Politicians Cleaned.csv", as.is = T) %>% 
  mutate(fullname=paste(first_name, last_name)) %>%
  mutate(date_of_birth=ymd_hms(date_of_birth))
colnames(metaDF)
```

Metadata on recent U.S. politicians have been aggregated by individuals working in Frances Rosenbluth's lab at Yale. They used sources such as [GovTrack](https://www.govtrack.us/), [Vote Smart](https://votesmart.org/),  and others to determine metadata characteristics of the 115th (2016 election) and 116th (2018 election) members of the U.S. congress (U.S. House and U.S. Senate). Columns include age, party, gender, senator or representative, polarization level via the [dw nominate metric](https://en.wikipedia.org/wiki/NOMINATE_(scaling_method)), and professional action characteristics such as the percentage of time they vote with their party.

## Election data

```{r}
ElectionsDF <- read.csv("US Elections Cleaned.csv", as.is = T)
ElectionsDF <- ElectionsDF %>% filter(year >= 2010) %>%
  mutate(vote_fraction=candidatevotes/totalvotes) %>%
  select(first_name, last_name, state, year, vote_fraction) %>%
  arrange(first_name, last_name, state, year)

nElec <- nrow(metaDF %>% inner_join(ElectionsDF, by=c("first_name", "last_name", "state")))
nInd <- nrow(metaDF %>% inner_join(ElectionsDF, by=c("first_name", "last_name", "state")) %>% count(first_name, last_name, state))

metaDFWElections <- metaDF %>% select(first_name, last_name, state) %>%
  inner_join(ElectionsDF, by=c("first_name", "last_name", "state"))
spreadVoteFraction <- metaDFWElections %>%
  spread(year, vote_fraction)
colnames(spreadVoteFraction) <- gsub("(201.)", "frac_votes_received_\\1", colnames(spreadVoteFraction))
# library(reshape2)
# spreadVoteFraction %>% melt(id=c("first_name", "last_name", "state")) # How to melt

metaDF <- metaDF %>% left_join(spreadVoteFraction, by=c("first_name", "last_name", "state"))
```

For this metadata, I pull in information on their elections from 2010 to 2016 from the [MIT Election Data Science Lab](https://electionlab.mit.edu/data). Over these four elections we have a total of `r nElec` elections from `r nInd` individuals. Although the metadata are harder to aggregate, in the future our lab will directly seek out losers of elections. For now, since most of the sitting congressmembers are incumbents from 2010 and through 2014, election success for an individual is treated comparatively as the fraction of votes they received in the election.

## Tweets

```{r}
# New metadata
tweetsMetaDF <- read.csv("pol_accounts.csv", as.is = T, sep=";")
# tweetsMetaDF <- read.csv("https://query.data.world/s/e7375jdc22jydnegcou4hsurtyezsf", as.is=T, sep=";")
tweetsMetaDF <- tweetsMetaDF %>% mutate(created_at=ymd_hms(created_at)) %>%
  mutate(id=as.character(id))
nrow(tweetsMetaDF)
# about 200 in the pol_accounts are not in my metadata, and about 190 are in my metadata but not in pol_accounts.
metaDF <- metaDF %>% inner_join(tweetsMetaDF, by=c("twitter_account"="screen_name")) %>%
  mutate(user_id=id) %>%
  select(-id)
# Easier for unspread elections
UserIDElections <- metaDFWElections %>% inner_join(metaDF %>% select(first_name, last_name, state, user_id)) %>%
  select(user_id, year, vote_fraction)

# Tweets
tweetsDF <- read.csv("pol_tweets.csv", as.is=T, sep=";")
# readRDS("tweetsDF.RDS")
# tweetsDF <- read.csv("https://query.data.world/s/dpgkibmlikucyt4kxchxzdgpriivzf", as.is=T, sep=";");
tweetsDF <- tweetsDF %>% mutate(created_at=ymd_hms(created_at)) %>%
  mutate(id=as.character(id)) %>%
  mutate(user_id=as.character(user_id)) %>%
  arrange(user_id, created_at) %>% 
  select(user_id, created_at, everything())

nTweets <- nrow(tweetsDF %>% select(user_id) %>% inner_join(metaDF %>% select(user_id)))
nIndiv <- nrow(tweetsDF %>% select(user_id) %>% inner_join(metaDF %>% select(user_id)) %>% count(user_id))
firstTweetTime <- tweetsDF[which.min(tweetsDF$created_at),]$created_at
latestTweetTime <- tweetsDF[which.max(tweetsDF$created_at),]$created_at

# Compute next election
electionYears <- c(2010, 2012, 2014, 2016)
electionDays <- c(ymd("2010-11-2"), ymd("2012-11-6"), ymd("2014-11-4"), ymd("2016-11-8"))
electionDaysLeadup <- c(ymd("2010-9-2"), ymd("2012-9-6"), ymd("2014-9-4"), ymd("2016-9-8"))
electionIndices <- c(1,2,3,4)
electionDateConversion <- data.frame(electionYears, electionDays, electionDaysLeadup, electionIndices)

# Tweets near elections
tweetsNearElections <- tweetsDF %>% select(id, created_at) %>% 
  filter(created_at < max(electionDays)) %>%
  mutate(nextElectionIs2010_1=(created_at>electionDaysLeadup[1] & created_at<electionDays[1]),
         nextElectionIs2012_2=(created_at>electionDaysLeadup[2] & created_at<electionDays[2]),
         nextElectionIs2014_3=(created_at>electionDaysLeadup[3] & created_at<electionDays[3]),
         nextElectionIs2016_4=(created_at>electionDaysLeadup[4] & created_at<electionDays[4])) %>%
  melt(id=c("id","created_at")) %>%
  filter(value) %>% select(-value) %>%
  mutate(nextElection=as.numeric(gsub(".*201._(.)", "\\1", variable))) %>% select(-variable) %>%
  mutate(nextElectionDate=electionDays[nextElection]) %>% 
  select(id, nextElection, nextElectionDate) %>%
  inner_join(tweetsDF)

table(tweetsNearElections$nextElection)

# Get up to fifty tweets from near elections
set.seed(123)

tweetsNearElections50 <- tweetsNearElections %>% group_by(user_id, nextElection) %>%
  filter(n()>30) %>%
  filter(row_number() %in% sample(seq(1,n()), min(50, n()))) %>%
  ungroup() 

table(tweetsNearElections$nextElection)
table(tweetsNearElections50$nextElection)

# Most have full 50.
# tweetsNearElections50 %>% count(user_id, nextElection) %>%
#   ggplot(aes(x=n)) + geom_histogram()

tweetsNearElections50 <- tweetsNearElections50 %>% arrange(user_id, created_at) %>% select(id, user_id, created_at, everything())

# 1039 docs
docsNearElections <- tweetsNearElections50 %>% group_by(user_id, nextElection) %>%
  summarise(doc=stringr::str_c(tweet_text, collapse = " -- ")) %>%
  ungroup() %>%
  mutate(doc_id=as.character(seq(length(doc))))
head(docsNearElections)
# For IBM
# write.csv(docsNearElections %>% select(doc_id, doc), "tweetDocsNearElections.csv", row.names = F)
# write.csv(docsNearElections, "tweetDocsNearElectionsWMeta.csv", row.names = F)
```

Tweets from this [data.world dataset](https://data.world/bkey/politician-tweets). We have `r nTweets` tweets from `r nIndiv` individuals in our metadata. In addition to the text of the tweet and when it was created (ranging from `r firstTweetTime` to `r latestTweetTime`), they've pulled out hashtag entities, favorite counts, retweets, and urls.

## Tones

```{r}
# Received from IBM
ibmDF <- read.csv("tweetDocsNearElectionsIBM.csv", as.is=T)
ibmDF <- ibmDF %>% mutate(doc_id=as.character(doc_id)) %>%
  group_by(tone_name) %>%
  mutate(standardizedScore=ecdf(score)(score), isHighScore=score>median(score)) %>%
  ungroup()

# A lot of people are tweeting before elections without actually having an election then. 1039 docs before elections -> 508 actually having an elections (and being in our dataset of elections)
# Also not everyone is in our twitterset. 1128 elections -> 508 with tweets
nrow(UserIDElections)
docsNearElectionsWPayoff <- UserIDElections %>% inner_join(electionDateConversion, by=c("year"="electionYears")) %>%
  select(user_id, electionDays, electionIndices, vote_fraction) %>%
  inner_join(docsNearElections, by=c("user_id", "electionIndices"="nextElection"))

metaDocsNearElections <- tweetsNearElections50 %>% group_by(user_id, nextElection) %>%
  summarise(fav_all=sum(favorites_count), ret_all=sum(retweet_count)) %>%
  inner_join(docsNearElections, by=c("user_id", "nextElection")) %>%
  inner_join(metaDF %>% select(user_id, first_name, last_name, gender)) %>% # Causes cut bc not all docs are in my metadata
  ungroup()
nrow(metaDocsNearElections)
  
metaDocsNearElectionsWPayoff <- tweetsNearElections50 %>% group_by(user_id, nextElection) %>%
  summarise(fav_all=sum(favorites_count), ret_all=sum(retweet_count)) %>%
             # Uses docs near elect w payoff
  inner_join(docsNearElectionsWPayoff, by=c("user_id", "nextElection"="electionIndices")) %>%
  inner_join(metaDF %>% select(user_id, first_name, last_name, gender)) %>% # No additional cut bc WPayoff required metadata on elections, already had joined w metadata
  ungroup()
nrow(metaDocsNearElectionsWPayoff)
tones <- unique(ibmDF$tone_name)
```

There has been a lot of work done on the text classification task of tones - the style with which someone makes an utterance. IBM Watson, the same that won Jeopardy in 2011, now has a feature of tagging tones in text, including specifically in Tweets. The tones tagged by IBM are `r tones`. Underneath the hood a neural net is used to classify the text. The most successful open-source projects for text classification include 

# Data Exploration

## Balance and Limitations of the Data

First we'll consider several ways in which the data is balanced (and some ways it's not), so that the more nuanced effects we find later aren't trivially explained by a biased dataset. On the left, we see the tweets broken down by gender and party. For most of the analysis, I'll be doing comparative work, choosing to drop independents. The breakdown of tweets is roughly proportional to the number of individuals in each category. Thus, when we take tweets per individual, shown at right, the distributions are pretty similar between groups.

```{r}
p1 <- tweetsDF %>% select(user_id) %>%
  inner_join(metaDF%>%select(-created_at)) %>%
  ggplot(aes(x=party, color=gender)) + geom_bar() +
  ggtitle("Tweet Counts vs. Gender and Party") + th

p2 <- tweetsDF %>% select(user_id) %>%
  inner_join(metaDF%>%select(-created_at)) %>%
  filter(party %in% c("D", "R")) %>%
  group_by(user_id) %>%
  summarise(party=party[[1]],
            gender=gender[[1]],
            n=n()) %>%
  ggplot(aes(x=party, y=n, color=gender)) + geom_boxplot() +
  ggtitle("Tweet Counts Grouped by Individual") + th

grid.arrange(p1, p2, nrow=1)
```

Next we turn to our election data. The dataset is unbalanced in that most individuals have won their elections. However, vote fraction received is still interesting; we see the between gender and party there is relative balance over the recent elections.

```{r}
metaDF %>% inner_join(ElectionsDF, by=c("first_name", "last_name", "state")) %>% 
  filter(party %in% c("D", "R")) %>%
  ggplot(aes(x=as.factor(year), y=vote_fraction, color=gender)) + 
  geom_boxplot() + ggtitle("Vote Fraction vs. Gender and Party Over Time") + th
```

Another way the dataset is unbalanced is when it comes to tweet frequencies over time: there are many more in recent years. This is due to the increased popularity in the medium. Standardized to individual, when we brek tweet frequency down by gender, we see that women only recently have started outpacing men.

```{r}
# It seems that, while everyone is tweeting more than before, women are perhaps slightly outpacing men recently in tweet frequency, only recently
metaDF %>% select(gender, user_id) %>% 
  inner_join(tweetsDF %>% select(created_at, user_id)) %>%
  group_by(user_id, month=floor_date(created_at, "month")) %>%
  summarise(n=n(), gender=gender[[1]]) %>%
  ggplot(aes(x=month, y=n, color=gender)) + geom_smooth() +
  ggtitle("Individual's Tweet Counts in Recent Years") + th
```

<!-- We can predict that bumps along the way might be caused by topics coming to the forefront. For instance, #Obamacare seems to be a major contributor to the spike near 2013. -->

```{r, eval=F}
# How much is Obamacare alone causing it?
hashtags_per_user %>%
  group_by(month=floor_date(created_at, "month")) %>%
  #summarise(Obamacount=length(which(hashtag=="betterway"))) %>%
  summarise(Obamacount=length(which(hashtag=="obamacare"))) %>%
  ggplot(aes(x=month, y=Obamacount)) + geom_point() + # geom_smooth() 
  ggtitle("Count of #Obamacare over time") + th
```

Tweet frequency does not seem to correspond much to greater election success for any combination of party and gender (shown below). Receiving more retweets also does getting retweets.

```{r}
p1 <- metaDF %>% select(user_id, frac_votes_received_2016, gender, party) %>% 
  inner_join(tweetsDF %>% select(created_at, user_id)) %>%
  filter(created_at>ymd("2014-1-1")) %>%
  group_by(user_id) %>%
  summarise(n=n(), 
            frac_votes_received_2016=frac_votes_received_2016[[1]], 
            gender=gender[[1]],
            party=party[[1]]) %>%
  mutate(gender_party=paste(gender, party)) %>%
  ggplot(aes(x=n, y=frac_votes_received_2016, color=gender_party)) + geom_smooth() + 
  xlab("Tweets Since 2014") + 
  ggtitle("2016 Votes vs. Tweet Count") + th #+
  #theme(legend.position = "none")
p1
```

```{r, eval=F}
# slight payoff for being retweeted more before elections
p2 <- metaDocsNearElectionsWPayoff %>% #filter(ecdf(ret_all)(ret_all)<.80) %>%
  ggplot(aes(x=log(ret_all), y=vote_fraction, color=gender)) + 
  geom_smooth() + # geom_point() #+ xlim(3,7.5)
  ggtitle("Vote Fraction vs. Retweets Preceding Election") + th
grid.arrange(p1, p2, nrow=1)
```

## Tweet Topics: Hashtags

Hashtags are a way for users to self-identify topics that relate to their tweets, so it's a good place to start when doing any content analysis on tweets.

```{r, fig.show = 'hide'}
hashtags_per_user <- tweetsDF %>% select(user_id, hashtag_entities, created_at, retweet_count) %>%
  mutate(hashtag_entities=gsub(",", " ", gsub("\\{(.*)\\}", "\\1", hashtag_entities), ","))  %>%
  unnest_tokens(hashtag, hashtag_entities)
# annoying id field drop
# hashtags_per_user <- data.frame(user_id=hashtags_per_user$user_id, hashtag=hashtags_per_user$hashtag, date=hashtags_per_user$ stringsAsFactors = F)
x <- hashtags_per_user %>% count(hashtag)
set.seed(1234)
wordcloud(words = x$hashtag, freq = x$n, min.freq = 500,
          max.words=200, random.order=FALSE, rot.per=0.35, 
          colors=brewer.pal(8, "Dark2"))
```

```{r}
seq1 <- seq(-.1,1.1,.2)
set.seed(1234)
hashtag_ret_success <- hashtags_per_user %>% inner_join(metaDF %>% select(user_id, gender, party)) %>%
  group_by(word=hashtag) %>% 
  #filter(n()>300) %>% 
  filter(n()/2000>runif(1)) %>%
  summarise(freq=n(), nM=length(which(gender=="M")), nW=length(which(gender=="F")), nD=length(which(party=="D")), nR=length(which(party=="R")), medianRetCount=median(retweet_count)) %>%
  mutate(frac=nW/freq) %>%
  mutate(color=cut(frac, breaks=seq1, labels=colorRampPalette(c("red", "blue"))(length(seq1)-1))) 
```

```{r, eval=F}
set.seed(1234)
my_graph <- wordcloud2(hashtag_ret_success %>% filter(freq>300), color=x$color)
my_graph
saveWidget(my_graph, "tmp.html", selfcontained = F)
#webshot("tmp.html", "wc1.png", delay = 5)#, vwidth = 2000, vheight = 2000)
```

<!-- ![wordcloud](wc1.png) -->

Different parties focus on different issues, and this comes across in their use of hashtags. The reception of these issues also differs on different topics. Inspired by a layout at https://www.tidytextmining.com/twitter.html, In the below, we place the hashtag on the x axis based on how much (log base 10) it gets used by democrats, y axis for republicans, and then we color the points by the standardized-to-zero-one-interval number of retweets it gets. Democrats seem to be getting slightly better retweet visibility for "their" hashtags vs. what Republicans receive for theirs.

<!-- Neither party seems to be dominating the other in terms of retweets. -->

```{r}
# https://www.tidytextmining.com/twitter.html

hashtag_ret_success %>% filter(nD>0 & nR>0) %>%
  ggplot(aes(x=nD, y=nR, color=ecdf(medianRetCount)(medianRetCount))) +
  geom_jitter(alpha = 0.01, size=2.5, width = 0.25, height = 0.25) +
  geom_text(aes(label = word), check_overlap = TRUE, vjust = 1.5) +
  scale_x_log10(labels = percent_format()) +
  scale_y_log10(labels = percent_format()) +
  geom_abline(color = "red") +
  theme(legend.title = element_blank()) +
  ggtitle("Retweets of Hashtags: Republican vs. Democrat") + th

summary(lm(log(1+medianRetCount)~nR+nD, data=hashtag_ret_success))

# x %>% ggplot(aes(x=nW, y=nM, color=ecdf(meanRetCount)(meanRetCount))) + 
#   geom_jitter(alpha = 0.1, size = 2.5, width = 0.25, height = 0.25) +
#   geom_text(aes(label = word), check_overlap = TRUE, vjust = 1.5) +
#   scale_x_log10(labels = percent_format()) +
#   scale_y_log10(labels = percent_format()) +
#   geom_abline(color = "red")
```

We can also ask how tweeting about different topics pays off come election day. To do this, we focus on tweets immediately preceding an election. Per individual, I randomly selected up to fifty tweets in the two months preceding each election. It seems that Democrats might be able to differentially find hashtags that correlate with election success.

```{r}
hashtags_per_user_near_elections <- tweetsNearElections %>% select(user_id, hashtag_entities, created_at, nextElection) %>%
  mutate(hashtag_entities=gsub(",", " ", gsub("\\{(.*)\\}", "\\1", hashtag_entities), ","))  %>%
  unnest_tokens(hashtag, hashtag_entities) %>% arrange(user_id, created_at) %>% 
  inner_join(electionDateConversion, by=c("nextElection"="electionIndices")) %>%
  inner_join(UserIDElections, by=c("user_id", "electionYears"="year")) %>%
  inner_join(metaDF%>%select(-created_at), by="user_id")
```

```{r}
seq2 <- seq(-1,1,.2)
seq3 <- seq(-.1,1.1,.2)
hashtag_success <- hashtags_per_user_near_elections %>% 
  drop_na(dw_nominate, vote_fraction, gender, party) %>%
  filter(party %in% c("D", "R"), gender %in% c("M", "F")) %>%
  # filter(electionYears==2016) %>%
  group_by(word=hashtag) %>%
  summarise(freq=n(), 
            nW=length(which(gender=="F")),
            nM=length(which(gender=="M")),
            nD=length(which(party=="D")),
            nR=length(which(party=="R")),
            pol=mean(dw_nominate), 
            success=median(vote_fraction)) %>%
  mutate(fracW=nW/(nW+nM), fracD=nD/(nD+nR)) %>%
  mutate(colorPol=cut(pol, breaks=seq2, 
                   labels=colorRampPalette(c("blue", "red"))(length(seq2)-1))) %>%
  mutate(colorSuccess=cut(success, breaks=seq3, 
                    labels=colorRampPalette(c("white", "black"))(length(seq3)-1))) %>%
  mutate(colorDem=cut(fracD, breaks=seq3, 
                    labels=colorRampPalette(c("red", "blue"))(length(seq3)-1))) %>%
  mutate(colorGender=cut(fracD, breaks=seq3, 
                    labels=colorRampPalette(c("white", "black"))(length(seq3)-1))) 

set.seed(1234)

# wordcloud2(x%>%filter(freq>10), color=x$colorPol)
#wordcloud2(x %>% filter(freq>10), color=x$colorSuccess)
# Not very interpretable
#wordcloud2(x %>% filter(freq>10), color=x$colorDem)
# Not very interpretable
#wordcloud2(x %>% filter(freq>10), color=x$colorGender)
```

```{r}
#x %>% mutate(election_success_pctl = #ecdf(success)(success)) %>%
hashtag_success %>% filter(nD>1 & nR>1 & n()/100>runif(1)) %>%
  ggplot(aes(x=nR, y=nD, color=ecdf(success)(success))) +
  geom_jitter(alpha = 0.01, size=2.5, width = 0.25, height = 0.25) +
  geom_text(aes(label = word), check_overlap = TRUE, vjust = 1.5) +
  scale_x_log10(labels = percent_format()) +
  scale_y_log10(labels = percent_format()) +
  geom_abline(color = "red") +
  theme(legend.title = element_blank()) +
  ggtitle("Hashtag Use and Vote Fraction: Democrat vs. Republican") + th

summary(lm(success ~ log(nD) + log(nR), data=hashtag_success%>%filter(nD>0 & nR>0)))
```


To add a dimension of gender, I collapse the prior axes by computing the fraction of democrats using the tweet (the rest are republican), and the fraction of women (the rest being men). This creates an area for republican women (top left), republican men (bottom left), etc. We see that while Democrat women are finding winning hashtags, republican women are lagging even behind republican men. This effect could be confounded by the fact that fewer women as a percentage are Republican visa vie Democrat.

```{r}
hashtag_success %>% filter(freq>10) %>%
  ggplot(aes(x=fracD, y=fracW, color=ecdf(success)(success))) +
  geom_jitter(alpha = 0.01, size=2.5, width = 0.25, height = 0.25) +
  geom_text(aes(label = word), check_overlap = TRUE, vjust = 1.5) +
  #scale_x_log10(labels = percent_format()) +
  #scale_y_log10(labels = percent_format()) +
  theme(legend.title = element_blank()) +
  ggtitle("Hashtags Use and Vote Fraction: Gender vs. Party") + th

summary(lm(success ~ fracW*fracD, data=hashtag_success))
```

```{r, eval=F}
hashtag_success %>% filter(nM>1 & nW>1 & n()/100>runif(1)) %>%
  ggplot(aes(x=nW, y=nM, color=ecdf(success)(success))) +
  geom_jitter(alpha = 0.01, size=2.5, width = 0.25, height = 0.25) +
  geom_text(aes(label = word), check_overlap = TRUE, vjust = 1.5) +
  scale_x_log10(labels = percent_format()) +
  scale_y_log10(labels = percent_format()) +
  geom_abline(color = "red") +
  theme(legend.title = element_blank()) +
  ggtitle("Hashtag Use and Vote Fraction: Male vs. Female") + th
```

## Tweet Tone

Now we turn to the tones that appear in the tweets. Similar to @Proctor, I find that the tone data is balanced in the sense that on aggregate there are no measurable effects of gendered tonal differences.

```{r, eval=F}
metaDocsNearElections %>% select(user_id, nextElection, doc_id, fav_all, ret_all, gender) %>%
  inner_join(ibmDF) %>% # 9386 rows
  ggplot(aes(x=tone_name, y=standardizedScore, color=gender)) + geom_boxplot() + ax
```

```{r, eval=F}
metaDocsNearElections %>% inner_join(ibmDF) %>% 
  filter(tone_name %in% sort(unique(ibmDF$tone_name))[8:13]) %>%
  ggplot(aes(x=tone_name, y=log(ret_all), color=gender, fill=isHighScore)) + geom_boxplot() + ax + scale_color_manual(values=c("black", "white"))

metaDocsNearElections %>% inner_join(ibmDF) %>% 
  filter(tone_name %in% sort(unique(ibmDF$tone_name))[1:7]) %>%
  ggplot(aes(x=tone_name, y=log(ret_all), color=gender, fill=isHighScore)) + geom_boxplot() + ax + scale_color_manual(values=c("black", "white"))
```

```{r}
# Overall, no effect. good.
# metaDocsNearElectionsWPayoff %>% select(doc_id, gender, vote_fraction) %>%
#   inner_join(ibmDF) %>%
#   ggplot(aes(x=standardizedScore, y=vote_fraction)) + geom_smooth() + geom_point()

# Nothing for openness.
# Women maybe hurt a little for tentative
# metaDocsNearElectionsWPayoff %>% select(doc_id, gender, vote_fraction) %>%
#   inner_join(ibmDF) %>%
#   filter(tone_name=="Tentative") %>%
#   ggplot(aes(x=standardizedScore, y=vote_fraction, color=gender)) + geom_smooth()
```

However, I find that women seem to be rewarded more for fear when it comes to election day success. The effect is similar for disgust, suggesting that pessimism in general is differentially rewarded for women.

```{r}
# Women helpfed for Fear, just like retweet more
metaDocsNearElectionsWPayoff %>% select(doc_id, gender, vote_fraction) %>%
  inner_join(ibmDF) %>%
  filter(tone_name=="Fear") %>%
  ggplot(aes(x=standardizedScore, y=vote_fraction, color=gender)) + 
  geom_smooth() + ggtitle("Fear vs. Vote Fraction Received") + th

# m2 <- lm(vote_fraction~standardizedScore*gender, data=metaDocsNearElectionsWPayoff %>%
#              select(doc_id, gender, vote_fraction) %>%
#              inner_join(ibmDF) %>%
#              filter(tone_name=="Disgust"))

#, results="asis"}
# library(stargazer)
# stargazer(m1, m2, header=FALSE, type='latex', single.row = TRUE, 
#           column.sep.width='1pt', omit.stat=c("f", "ser", "adj.rsq"),
#           font.size = "small")
```

```{r, eval=F}
# Also helped for disgust
metaDocsNearElectionsWPayoff %>% select(doc_id, gender, vote_fraction) %>%
  inner_join(ibmDF) %>%
  filter(tone_name=="Disgust") %>%
  ggplot(aes(x=standardizedScore, y=vote_fraction, color=gender)) + geom_smooth()

# Both hurt for joy
metaDocsNearElectionsWPayoff %>% select(doc_id, gender, vote_fraction) %>%
  inner_join(ibmDF) %>%
  filter(tone_name=="Joy") %>%
  ggplot(aes(x=standardizedScore, y=vote_fraction, color=gender)) + geom_smooth()

# A little for Anger, confident helps if SUPER confident
metaDocsNearElectionsWPayoff %>% select(doc_id, gender, vote_fraction) %>%
  inner_join(ibmDF) %>%
  filter(tone_name=="Confident") %>%
  ggplot(aes(x=standardizedScore, y=vote_fraction, color=gender)) + geom_smooth()
```

```{r, eval=F}
summary(lm(vote_fraction~standardizedScore*tone_name*gender, data=metaDocsNearElectionsWPayoff %>% select(doc_id, gender, vote_fraction) %>%
  inner_join(ibmDF)))
```

One partial explanation for the above is that women are retweeted more when they are expressing these pessimistic tones.
<!-- * We see men get helped if they are open, women helped if NOT open. -->

```{r, eval=F}
metaDocsNearElections %>% inner_join(ibmDF) %>%
  filter(tone_name=="Openness") %>%
  ggplot(aes(x=gender, y=log(ret_all), fill=isHighScore)) + geom_boxplot()
metaDocsNearElections %>% inner_join(ibmDF) %>%
  filter(tone_name=="Confident") %>%
  ggplot(aes(x=gender, y=log(ret_all), fill=isHighScore)) + geom_boxplot()
```

```{r}
metaDocsNearElections %>% inner_join(ibmDF) %>%
  filter(tone_name %in% c("Fear", "Joy")) %>%
  mutate(HighToneScore=isHighScore) %>%
  ggplot(aes(x=paste0(gender, ": ", tone_name), y=log(ret_all), fill=HighToneScore)) + geom_boxplot() +
  ggtitle("Female Pessimism Receives Retweet Reward") + th +
  theme(axis.title.x=element_blank())
```

```{r, eval=F}
summary(lm(log(ret_all)~gender*isHighScore*tone_name, data=metaDocsNearElections %>% inner_join(ibmDF)))
# summary(lm(log(ret_all)~gender*isHighScore, data=metaDocsNearElections %>% inner_join(ibmDF) %>%
#   filter(tone_name=="Fear"))) # *
# summary(lm(log(ret_all)~gender*isHighScore, data=metaDocsNearElections %>% inner_join(ibmDF) %>%
#   filter(tone_name=="Joy"))) # *
# summary(lm(log(ret_all)~gender*isHighScore, data=metaDocsNearElections %>% inner_join(ibmDF) %>%
#   filter(tone_name=="Confident"))) # *
```


<!-- ## Topic models -->

<!-- I will run topic models on on the tweets directly, but to start I just focused on the hashtags. -->

```{r, eval=F}
hashtagDTM <- hashtags_per_user %>% count(user_id, hashtag) %>%
  cast_dtm(user_id, hashtag, n)
hashtagDTM %>% tidy() %>% arrange(document)
```

<!-- Running directly on tweets: -->

```{r, eval=F}
# https://piazza.com/class/jl26r45x64v60r?cid=251
stack <- metaDocsNearElectionsWPayoff %>% select(doc_id, doc) %>% # rename columns
  unnest_tokens(output = word, 
                input = doc,
                to_lower = TRUE,
                drop = TRUE,
                strip_punct = TRUE,
                strip_numeric = TRUE) %>% # tokenizes
  anti_join(stop_words, by = "word") %>% # removes stopwords (for example, removes 'what', 'is', and 'about')
  mutate(word = lemmatize_words(word)) %>% # lemmatizes words (for example, combines 'test', 'tests', and 'testing'
  group_by(doc_id, word) %>%
  summarize(n = n()) # count word frequency per word per document

wordFreq <- stack %>%
  group_by(word) %>%
  summarize(n = n())

vocabulary <- wordFreq %>%
  filter(n >= 20) %>%
  filter(!str_detect(word, "\\d")) %>% # keep words that have no digits
  filter(!str_detect(word, "\\.")) %>% # keep words that have no periods
  filter(!(word %in% c("https", "http", "rt", "amp")))
  # add additional statements here to trim vocabulary

stackTrimmed <- semi_join(stack, vocabulary, by = "word")
# the semi-join takes the stack dataframe and remove all rows where the value of the "word" column cannot be found in the vocabulary dataframe's "word" column

stackDTM <- cast_dtm(stackTrimmed, term = word, document = doc_id, value = n)

seq1 <- seq(-.1,1.1,.2)
x <- stackTrimmed %>% inner_join(metaDocsNearElectionsWPayoff %>% select(doc_id, gender) %>% filter(gender=="F")) %>%
  inner_join(ibmDF%>%filter(tone_name=="Anger")) %>%
  group_by(word) %>% filter(n()>10) %>%
  summarise(freq=n(), frac=mean(standardizedScore)) %>%
  mutate(color=cut(frac, breaks=seq1, labels=colorRampPalette(c("white", "black"))(length(seq1)-1))) 

set.seed(1234)
# wordcloud2(x, color=x$color)
```


```{r, eval=F}
hash_lda <- LDA(stackDTM, k=6, control = list(seed = 1234))

# Hashtags
# hash_lda <- LDA(hashtagDTM, k=6, control = list(seed = 1234))
```

<!-- The most common words in a six-topic model are shown: -->

```{r, eval=F}
hash_topics <- tidy(hash_lda, matrix = "beta")
hash_topics

hash_top_terms <- hash_topics %>%
  group_by(topic) %>%
  top_n(10, beta) %>%
  ungroup() %>%
  arrange(topic, -beta)

hash_top_terms %>%
  mutate(term = reorder(term, beta)) %>%
  ggplot(aes(term, beta, fill = factor(topic))) +
  geom_col(show.legend = FALSE) +
  facet_wrap(~ topic, scales = "free") +
  coord_flip()
```

<!-- Breaking this down by gender, we find that women are tweeting more on the second topic. -->

```{r, eval=F}
hash_documents <- tidy(hash_lda, matrix = "gamma")
hash_documents
hash_documents %>% arrange(document, topic)
hash_documents %>% inner_join(metaDocsNearElectionsWPayoff %>% select(doc_id, gender), by=c("document"="doc_id")) %>%
# hashtags
#hash_documents %>% inner_join(metaDF %>% select(user_id, gender), by=c("document"="user_id")) %>%
  group_by(topic, gender) %>%
  summarise(meanGam=mean(gamma)) %>%
  ggplot(aes(x=as.factor(topic), y=meanGam, color=gender)) + geom_point()
```

# Analysis

## Tweet Frequency

We saw earlier that female individuals are tweeting more than men, only recently. This effect can be approximated by a linear model fitting tweet count over time versus gender. The effect suggested by the plot is statistically significant. As time goes by, the fitted model has men losing in frequency versus women.

```{r, results="show"}
mFreqMvsF <- lm(n ~ month*gender, data=metaDF %>% select(gender, user_id) %>% 
          inner_join(tweetsDF %>% select(created_at, user_id)) %>% 
          group_by(user_id, month=floor_date(created_at, "month")) %>%
          summarise(n=n(), gender=gender[[1]]))
pander(mFreqMvsF)
```

## Hashtags

We know that the dataset is balanced in that tweeting more or receiving more retweets does not straight-forwardly interact with party, gender, or ultimate success. Therefore, the nuance we add by honing in on specific hashtags is interesting. We find all three effects suggested are significant.

```{r, results="show"}
pander(lm(log(1+medianRetCount)~nR+nD, data=hashtag_ret_success))
pander(lm(success ~ log(nD) + log(nR), data=hashtag_success%>%filter(nD>0 & nR>0)))
pander(lm(success ~ fracW*fracD, data=hashtag_success))
```


## Tone

I also find that the effect of tone expressed before elections on election outcome is statistically significant. Again we use a linear model to approximate the effect of standardized tone score interacted with gender.

```{r, results="show"}
mFear <- lm(vote_fraction~standardizedScore*gender, data=metaDocsNearElectionsWPayoff %>%
             select(doc_id, gender, vote_fraction) %>%
             inner_join(ibmDF) %>%
             filter(tone_name=="Fear"))
pander(mFear)
```


# Confounders

## Dataset limitations

As mentioned earlier, this dataset lacks balance between election winners and losers; most elections our politicians ran in they won. This leads to an inherent confounder: if more of X (e.g. tone of Fear, using a certain hashtag) relates with higher vote fraction, maybe this just indicates that sure-win candidates feel emboldened/consequence free to use X. This is a particularly salient correlation-causation, "chicken-and-egg" problem with this approach.

## Real-world limitations

We know that politicians at the highest level have campaign teams to manage their social media accounts; the question of "who is actually tweeting?" is hard to answer. Both candidates and social media teams have payoff models and concious strategies for their tweeting. Thus, tweet strategies and election payoffs are confounded together to the extent that the best-funded, incumbent, and/or more-likely-to-win candidates have the best social media teams, quickest to identify and adopt a predicted-successful social media strategy.

In addition to the question of who is tweeting, we should also ask who is viewing these tweets and/or retweeting. @Pablo analyzes to the extent that social media is an echo chamber vs. a national conversation. If social media is more of an echo chamber, more extreme "rally-the-base" style strategies should be seen. Therefore, women might still experience gendered language pressures that are not exposed in their tweets.

# Conclusion and Future Work

Future work would seek to learn topics on tweets, above just treating hashtags as topics. Some research has suggested that women feel more comfortable advocating for marginalized groups, so aligning topics to tones is an important next step. Learning topics on tweets is hard because of the shortness of these documents; topics rely on repeated document co-occurences of words. But @sharifirad-etal-2018-boosting find that language models learned on tweets concatenated together with metadata characteristics of who is tweeting can achieve greater accuracy and data efficiency; this dataset is ripe for a similar approach.

# References

# Appendix

## Code

Here is the r code I used on the project. Also see https://github.com/daveyproctor/Polyspeech for the full repository with dataset.

```{r ref.label=knitr::all_labels(), echo=T, eval=F}

```



